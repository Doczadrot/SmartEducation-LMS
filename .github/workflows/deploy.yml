
name: Test and Deploy


on:
  push:
    branches: [ main, develop ]    # –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–∫–∏
  pull_request:
    branches: [ main ]             # –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PR –≤ main

jobs:
  # üß™ –®–∞–≥ 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  test:
    runs-on: ubuntu-latest
    
    # –ù—É–∂–Ω—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_smarteducation
        ports:
          - 5432:5432
      
      redis:
        image: redis:latest
        ports:
          - 6379:6379

    steps:

    - name:  –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
    - name: üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    - name: üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
      env:
        SECRET_KEY: 'test-key-for-github-actions'
        DEBUG: 'False'
        POSTGRES_DB: test_smarteducation
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
        DB_HOST: localhost
        DB_PORT: 5432
        REDIS_URL: redis://localhost:6379/0
      run: |
        cd SmartEducation
        python manage.py migrate
        python manage.py test


  deploy:
    needs: test                    
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # –¢–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏

    steps:
    # –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥
    - name: –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH –∫–ª—é—á
    - name: üîë –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –ø—Ä–æ–µ–∫—Ç–∞
    - name: üì¶ –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤
      run: |
        tar --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            -czf smarteducation.tar.gz .

    - name:  –î–µ–ø–ª–æ–∏–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
${{ secrets.POSTGRES_PASSWORD }}      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: 
      run: |
        # –ö–æ–ø–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        scp -o StrictHostKeyChecking=no smarteducation.tar.gz $SERVER_USER@$SERVER_HOST:/tmp/

        # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          sudo systemctl stop smarteducation || true
          
          # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
          if [ -d "/home/ubuntu/SmartEducation" ]; then
            sudo cp -r /home/ubuntu/SmartEducation /home/ubuntu/SmartEducation.backup
          fi
          
          # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
          cd /home/ubuntu
          rm -rf SmartEducation_new
          mkdir SmartEducation_new
          cd SmartEducation_new
          tar -xzf /tmp/smarteducation.tar.gz
          
          # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
          cat > .env << ENV_EOF
        SECRET_KEY=$SECRET_KEY
        DEBUG=False
        ALLOWED_HOSTS=$SERVER_HOST,localhost,127.0.0.1
        POSTGRES_DB=$POSTGRES_DB
        POSTGRES_USER=$POSTGRES_USER
        POSTGRES_PASSWORD=$POSTGRES_PASSWORD
        DB_HOST=localhost
        DB_PORT=5432
        REDIS_URL=redis://localhost:6379/0
        ENV_EOF
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –º–∏–≥—Ä–∏—Ä—É–µ–º
          source /home/ubuntu/venv/bin/activate
          pip install -r requirements.txt
          cd SmartEducation
          python manage.py migrate
          python manage.py collectstatic --noinput
          
          # –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é
          cd /home/ubuntu
          if [ -d "SmartEducation" ]; then
            rm -rf SmartEducation
          fi
          mv SmartEducation_new SmartEducation
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          sudo systemctl start smarteducation
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
        EOF

